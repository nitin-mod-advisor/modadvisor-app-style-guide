/**
 * @fileoverview Firestore Security Rules for Color Palette Management
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for color palettes and their associated colors.
 * Each user has full control over their own color palettes and colors, and no access to others' data.
 *
 * Data Structure:
 * All data is nested under /users/{userId}, ensuring clear ownership and simplifying security rules.
 * - /users/{userId}/colorPalettes/{colorPaletteId}: Stores color palette documents.
 * - /users/{userId}/colorPalettes/{colorPaletteId}/colors/{colorId}: Stores individual color documents.
 *
 * Key Security Decisions:
 * - User listing is disallowed to protect user privacy.
 * - Data validation is limited to ownership checks to allow for flexible data shapes during prototyping.
 * - The rules are designed to be authorization-independent, relying on path-based ownership to avoid costly `get()` calls.
 *
 * Denormalization for Authorization:
 * The user ID is embedded in the document path itself (/users/{userId}/...) to enforce ownership.
 * This avoids the need for storing a separate ownerId field in the document data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces access control for user documents.
     * @path /users/{userId}
     * @allow (create) - If the user ID in the path matches the authenticated user's ID (self-creation).
     * @deny (get, list, update, delete) - All other operations are forbidden to protect user privacy.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId} {
      // disallow all other operations on the user document itself
      allow get, list, update, delete: if false;

      // Allow the user to create their own document.
      allow create: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Enforces owner-only access to color palettes.
     * @path /users/{userId}/colorPalettes/{colorPaletteId}
     * @allow (get, list) - If the user ID in the path matches the authenticated user's ID.
     * @allow (create) - If the user ID in the path matches the authenticated user's ID.
     * @allow (update, delete) - If the user ID in the path matches the authenticated user's ID and the document exists.
     * @deny (all others) - If the user ID in the path does not match the authenticated user's ID.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/colorPalettes/{colorPaletteId} {
      allow get, list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == colorPaletteId;
      allow update: if isSignedIn() && isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Enforces owner-only access to colors within a color palette.
     * @path /users/{userId}/colorPalettes/{colorPaletteId}/colors/{colorId}
     * @allow (get, list) - If the user ID in the path matches the authenticated user's ID.
     * @allow (create) - If the user ID in the path matches the authenticated user's ID.
     * @allow (update, delete) - If the user ID in the path matches the authenticated user's ID and the document exists.
     * @deny (all others) - If the user ID in the path does not match the authenticated user's ID.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/colorPalettes/{colorPaletteId}/colors/{colorId} {
      allow get, list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.colorPaletteId == colorPaletteId;
      allow update: if isSignedIn() && isExistingOwner(userId) && request.resource.data.colorPaletteId == resource.data.colorPaletteId;
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    // --- Helper functions ---

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the resource.
     * @param {string} userId The user ID to check against.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the owner of the resource and if the resource exists.
     * @param {string} userId The user ID to check against.
     * @return {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
  }
}